name: Tests/Release

on:
  workflow_dispatch:
    inputs:
      publish:
        description: "Publish built distributions to PyPI"
        required: false
        default: false
        type: boolean
  release:
    types:
      - published
  push:
    branches:
      - main
    paths:
      - "VERSION"

jobs:
  # Build & test sdist before spending time on the wheel matrix.
  sdist:
    name: Creating source release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setting up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install uv
        run: python -m pip install --upgrade uv

      - name: Set version from tag (release only)
        if: github.event_name == 'release'
        shell: python
        run: |
          import os
          tag = os.environ["GITHUB_REF_NAME"]
          if tag.startswith("v"):
            tag = tag[1:]
          with open("VERSION", "w", encoding="utf-8") as f:
            f.write(tag + "\n")
          print(f"VERSION={tag}")

      - name: Build sdist
        run: uv build --sdist

      - uses: actions/upload-artifact@v4
        with:
          name: dist-sdist
          path: dist/*.tar.gz

  build_wheels:
    needs: [sdist]
    name: "[${{ strategy.job-index }}/${{ strategy.job-total }}] ${{ matrix.py }} on ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, windows-latest, macos-14]
        py: ["cp311", "cp312", "cp313"]
        # py: ["cp39", "cp310", "cp311", "cp312", "cp313"]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setting up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up QEMU
        if: runner.os == 'Linux'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set version from tag (release only)
        if: github.event_name == 'release'
        shell: python
        run: |
          import os
          tag = os.environ["GITHUB_REF_NAME"]
          if tag.startswith("v"):
            tag = tag[1:]
          with open("VERSION", "w", encoding="utf-8") as f:
            f.write(tag + "\n")
          print(f"VERSION={tag}")

      - name: Build & test wheels
        uses: pypa/cibuildwheel@v2.22.0
        env:
          CIBW_BUILD: "${{ matrix.py }}-*"

      - uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.os }}-${{ matrix.py }}
          path: ./wheelhouse/*.whl

  publish:
    name: Publish to PyPI
    needs: [build_wheels, sdist]
    if: github.event_name == 'release' || github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish)
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          merge-multiple: true
          path: dist

      # - name: Publish with API token (if configured)
      #   if: secrets.PYPI_API_TOKEN != ''
      #   uses: pypa/gh-action-pypi-publish@release/v1
      #   with:
      #     password: ${{ secrets.PYPI_API_TOKEN }}

      - name: Publish with Trusted Publishing (OIDC)
        # if: secrets.PYPI_API_TOKEN == ''
        uses: pypa/gh-action-pypi-publish@release/v1
